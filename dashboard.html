<!DOCTYPE html>
<html>
<head>
  <title>Buktiku by Fitrah Suhendri - Dashboard</title>
  <link rel="stylesheet" href="style.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
</head>
<body>

<div class="loader" id="loader">
  <div class="spinner"></div>
</div>

<div class="bg-glow"></div>

<div class="dashboard">

  <div class="topbar">
    <img id="photo" class="profile">
    <div>
      <h2 id="name"></h2>
      <p id="email"></p>
    </div>
    <button onclick="logout()" class="btn small">Logout</button>
  </div>

  <div class="upload-box">
    <h3>Upload Bukti Transaksi</h3>
    <input type="file" id="fileInput">
    <button onclick="uploadFile()" class="btn">Upload</button>
  </div>

  <div class="transaction-list" id="list">
    <h3>Riwayat Upload</h3>
  </div>

</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBIaTx9x1_yz5N6t0uBp2eTc7tIBhMLRQA",
    authDomain: "buktiku-6e36b.firebaseapp.com",
    projectId: "buktiku-6e36b",
    storageBucket: "buktiku-6e36b.appspot.com",
    messagingSenderId: "864927339878",
    appId: "1:864927339878:web:e11a53ac31e63c098c64a7"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const storage = firebase.storage();

  const loader = document.getElementById("loader");

  auth.onAuthStateChanged(user => {
    if(user){
      document.getElementById("name").innerText = user.displayName;
      document.getElementById("email").innerText = user.email;
      document.getElementById("photo").src = user.photoURL;
      loader.style.display = "none";
    } else {
      window.location.href = "index.html";
    }
  });

  function uploadFile(){
    const file = document.getElementById("fileInput").files[0];
    if(!file){
      alert("Pilih file dulu!");
      return;
    }

    loader.style.display = "flex";

    const user = auth.currentUser;
    const storageRef = storage.ref("bukti/" + user.uid + "/" + file.name);

    storageRef.put(file).then(() => {
      storageRef.getDownloadURL().then(url => {
        addToList(url, file.name);
        loader.style.display = "none";
      });
    });
  }

  function addToList(url, name){
    const list = document.getElementById("list");
    const item = document.createElement("div");
    item.className = "transaction-item";
    item.innerHTML = `
      <p>${name}</p>
      <a href="${url}" target="_blank">Lihat</a>
    `;
    list.appendChild(item);
  }

  function logout(){
    auth.signOut().then(()=>{
      window.location.href = "index.html";
    });
  }
</script>

</body>
</html>